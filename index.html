<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoFlow Tracker - BTC/ETH ETF 비교</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* 기본 스타일 */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            background-color: #121826;
            color: #E5ECF6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        a {
            color: #FFB800;
            text-decoration: none;
        }
        /* 헤더 스타일 */
        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px solid #2a3f5f;
        }
        .logo-section {
            display: flex;
            flex-direction: column;
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        .timestamp {
            font-size: 12px;
            color: #8c9db3;
            margin-top: 5px;
        }
        /* BTC/ETH 전환 버튼 스타일 */
        .coin-switcher {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .coin-switcher button {
            background-color: #2a3f5f;
            color: #E5ECF6;
            border: 1px solid #2a3f5f;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .coin-switcher button:hover {
            background-color: #3e5681;
        }
        .coin-switcher button.active {
            background-color: #FFB800;
            color: #121826;
            border-color: #FFB800;
        }
        .coin-switcher button i {
            margin-right: 8px;
        }
        .header-metrics {
            display: flex;
            gap: 40px;
        }
        .live-crypto-price, .live-etf-inflow {
            text-align: right;
        }
        .live-crypto-price .price, .live-etf-inflow .total {
            font-size: 28px;
            font-weight: bold;
        }
        .live-crypto-price .change, .live-etf-inflow .change {
            font-size: 16px;
        }
        /* 공통 상승/하락 색상 */
        .up { color: #4CAF50 !important; }
        .down { color: #F44336 !important; }
        /* 메인 대시보드 스타일 */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .main-chart-container {
            background-color: #1A2233;
            padding: 20px;
            border-radius: 8px;
            height: 500px;
            position: relative;
        }
        h2 {
            margin-top: 0;
            font-weight: 500;
        }
        
        /* 상세 비교 차트 섹션 스타일 */
        .comparison-chart-section {
            background-color: #1A2233;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            position: relative;
        }
        .comparison-chart-section iframe {
            width: 100%;
            height: 500px;
            border: none;
            margin-top: 15px;
        }
        /* ▼▼▼ [추가] 차트 헤더 및 바로가기 버튼 스타일 ▼▼▼ */
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2a3f5f;
            padding-bottom: 10px;
        }
        .chart-header h2 {
            margin: 0;
            padding: 0;
            border-bottom: none;
        }
        .source-link-btn {
            background-color: #2a3f5f;
            color: #E5ECF6;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            text-decoration: none;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        .source-link-btn:hover {
            background-color: #3e5681;
        }
        .source-link-btn i {
            margin-left: 5px;
        }

        /* 전체 화면 버튼 스타일 */
        #fullscreen-btn {
            position: absolute;
            top: 18px;
            right: 20px;
            background-color: #2a3f5f;
            border: 1px solid #4a5f7f;
            color: #E5ECF6;
            cursor: pointer;
            border-radius: 5px;
            width: 32px;
            height: 32px;
            font-size: 18px;
            line-height: 30px;
            text-align: center;
        }
        /* 전체 화면 모드 스타일 */
        .comparison-chart-section.fullscreen-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            border-radius: 0;
        }
        .fullscreen-mode iframe {
            height: calc(100% - 60px);
        }
        .fullscreen-mode #fullscreen-btn {
            top: 25px;
            right: 25px;
            z-index: 1001;
        }
        /* 푸터 스타일 */
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            border-top: 1px solid #2a3f5f;
            font-size: 14px;
            color: #8c9db3;
            line-height: 1.6;
        }
        .chart-source {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 12px;
            color: #8c9db3;
            z-index: 10;
        }
    </style>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QBCMWL9C06"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QBCMWL9C06');
</script>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-section">
                <div class="logo">
                    <a href="#">CryptoFlow Tracker</a>
                </div>
                <div class="coin-switcher">
                    <button id="btn-btc" class="active"><i class="fa-brands fa-bitcoin"></i>BTC</button>
                    <button id="btn-eth"><i class="fa-brands fa-ethereum"></i>ETH</button>
                </div>
                <div class="timestamp" id="timestamp-display">Loading time...</div>
            </div>
            <div class="header-metrics">
                <div class="live-etf-inflow">
                    <div id="etf-title">Total ETF Net Inflow</div>
                    <div class="total" id="etf-inflow-total">Loading...</div>
                    <div class="change" id="etf-inflow-change"></div>
                </div>
                <div class="live-crypto-price">
                    <div id="price-title">Bitcoin Price</div>
                    <div class="price" id="crypto-price">Loading...</div>
                    <div class="change" id="crypto-change"></div>
                </div>
            </div>
        </header>

        <main>
            <div class="dashboard">
                <div class="main-chart-container">
                    <h2 id="chart-title" style="border-bottom: 1px solid #2a3f5f; padding-bottom: 10px;">실시간 비트코인 가격</h2>
                    <div id="chart-container" style="height: calc(100% - 45px); width:100%;"></div>
                    <div class="chart-source">Source: TradingView</div>
                </div>
            </div>
            
            <div id="comparison-chart-container" class="comparison-chart-section">
                <div class="chart-header">
                    <h2 id="comparison-chart-title">BTC 현물 ETF 현금 흐름 & 가격 비교</h2>
                    <a id="farside-link-btn" href="#" target="_blank" class="source-link-btn">
                        Farside 데이터 확인 <i class="fa-solid fa-arrow-up-right-from-square"></i>
                    </a>
                </div>
                <button id="fullscreen-btn" title="전체 화면">↗</button>
                <iframe id="comparison-chart-iframe" src="graph_btc.html"></iframe>
            </div>

        </main>
        
        <footer>
            <p>Website ver: 2.1 ver | Spot ETF Flow Source: <a href="https://farside.co.uk/" target="_blank">Farside Investors</a></p>
            <p>Created by: <a href="mailto:dlwpsms3gkrsus@gmail.com">dlwpsms3gkrsus@gmail.com</a></p>
        </footer>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        // --- DOM 요소 가져오기 ---
        const btcBtn = document.getElementById('btn-btc');
        const ethBtn = document.getElementById('btn-eth');
        const priceTitleElement = document.getElementById('price-title');
        const cryptoPriceElement = document.getElementById('crypto-price');
        const cryptoChangeElement = document.getElementById('crypto-change');
        const etfTitleElement = document.getElementById('etf-title');
        const etfTotalElement = document.getElementById('etf-inflow-total');
        const etfChangeElement = document.getElementById('etf-inflow-change');
        const chartTitleElement = document.getElementById('chart-title');
        const chartContainer = document.getElementById('chart-container');
        const timestampElement = document.getElementById('timestamp-display');
        const comparisonChartTitle = document.getElementById('comparison-chart-title');
        const comparisonChartIframe = document.getElementById('comparison-chart-iframe');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const comparisonChartContainer = document.getElementById('comparison-chart-container');
        const farsideLinkBtn = document.getElementById('farside-link-btn'); // 바로가기 버튼 요소 추가
        
        // --- 상태 관리 ---
        let currentCoin = 'BTC';
        let lastPrice = 0;
        let tradingViewWidget;

        // --- 데이터 업데이트 함수 ---

        // 1. 실시간 가격 가져오기
        async function fetchPrice(coin) {
            try {
                const response = await fetch(`https://min-api.cryptocompare.com/data/pricemultifull?fsyms=${coin}&tsyms=USD`);
                const data = await response.json();
                const priceData = data.RAW[coin].USD;
                
                priceTitleElement.innerText = `${coin === 'BTC' ? 'Bitcoin' : 'Ethereum'} Price`;
                cryptoPriceElement.innerText = `$${priceData.PRICE.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                
                const sign = priceData.CHANGE24HOUR >= 0 ? '+' : '';
                cryptoChangeElement.innerText = `${sign}${priceData.CHANGE24HOUR.toFixed(2)} (${sign}${priceData.CHANGEPCT24HOUR.toFixed(2)}%)`;
                
                cryptoPriceElement.classList.toggle('up', priceData.PRICE > lastPrice);
                cryptoPriceElement.classList.toggle('down', priceData.PRICE < lastPrice);
                cryptoChangeElement.classList.toggle('up', priceData.CHANGE24HOUR >= 0);
                cryptoChangeElement.classList.toggle('down', priceData.CHANGE24HOUR < 0);
                
                lastPrice = priceData.PRICE;
            } catch (error) {
                console.error(`Error fetching ${coin} price:`, error);
                cryptoPriceElement.innerText = 'Error';
            }
        }

        // 2. CSV 파일에서 ETF 데이터 읽어오기
        async function displayEtfData(coin) {
            etfTitleElement.innerText = `Total ${coin} ETF Net Inflow`;
            const csvFileName = coin === 'BTC' ? 'bitcoin_etf_total_flow.csv' : 'ethereum_etf_total_flow.csv';

            try {
                const response = await fetch(csvFileName);
                if (!response.ok) throw new Error('Network response was not ok.');
                const csvText = await response.text();
                const rows = csvText.trim().split('\n');
                
                const lastRow = rows[rows.length - 1];
                const dailyInflow = parseFloat(lastRow.split(',')[1]);

                let cumulativeInflow = 0;
                for (let i = 1; i < rows.length; i++) {
                    const value = parseFloat(rows[i].split(',')[1]);
                    if (!isNaN(value)) cumulativeInflow += value;
                }
                
                const formatLargeNumber = (num) => {
                    if (Math.abs(num) >= 1.0e+9) return `$${(num / 1.0e+9).toFixed(2)}B`;
                    if (Math.abs(num) >= 1.0e+6) return `$${(num / 1.0e+6).toFixed(2)}M`;
                    return `$${num.toLocaleString()}`;
                };

                etfTotalElement.innerText = formatLargeNumber(cumulativeInflow * 1000000);
                const sign = dailyInflow >= 0 ? '+' : '';
                etfChangeElement.innerText = `${sign}${formatLargeNumber(dailyInflow * 1000000)} (Daily)`;
                
                etfTotalElement.classList.toggle('up', cumulativeInflow >= 0);
                etfTotalElement.classList.toggle('down', cumulativeInflow < 0);
                etfChangeElement.classList.toggle('up', dailyInflow >= 0);
                etfChangeElement.classList.toggle('down', dailyInflow < 0);

            } catch (error) {
                console.error(`Error fetching or parsing ${csvFileName}:`, error);
                etfTotalElement.innerText = '데이터 로드 실패';
                etfChangeElement.innerText = '';
            }
        }
        
        // 3. 실시간 차트 업데이트
        function updateChart(coin) {
            chartTitleElement.innerText = `실시간 ${coin === 'BTC' ? '비트코인' : '이더리움'} 가격`;
            chartContainer.innerHTML = '';
            tradingViewWidget = new TradingView.widget({
                "autosize": true, "symbol": `BITSTAMP:${coin}USD`, "interval": "D",
                "timezone": "Etc/UTC", "theme": "dark", "style": "1", "locale": "ko",
                "enable_publishing": false, "allow_symbol_change": false, "container_id": "chart-container"
            });
        }
        
        // 4. 현재 시간 표시
        function displayCurrentTime() {
            const now = new Date();
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            const usEasternTime = now.toLocaleString('en-US', { ...options, timeZone: 'America/New_York' });
            const koreaTime = now.toLocaleString('ko-KR', { ...options, timeZone: 'Asia/Seoul' });
            timestampElement.innerHTML = `🇺🇸 ${usEasternTime} (US Eastern)<br>🇰🇷 ${koreaTime} (Korea)`;
        }

        // ▼▼▼ [수정] 5. 상세 비교 차트 업데이트 ▼▼▼
        function updateComparisonChart(coin) {
            const coinName = coin === 'BTC' ? 'BTC' : 'ETH';
            const chartFile = coin === 'BTC' ? 'graph_btc.html' : 'graph_eth.html';
            const farsideLink = coin === 'BTC' 
                ? 'https://farside.co.uk/btc/' 
                : 'https://farside.co.uk/eth/';
            
            comparisonChartTitle.innerText = `${coinName} 현물 ETF 현금 흐름 & 가격 비교`;
            comparisonChartIframe.src = chartFile;
            farsideLinkBtn.href = farsideLink; // 바로가기 버튼의 링크를 동적으로 변경
        }

        // --- 메인 컨트롤 함수 ---
        function updateDashboard() {
            lastPrice = 0;
            fetchPrice(currentCoin);
            displayEtfData(currentCoin);
            updateChart(currentCoin);
            updateComparisonChart(currentCoin);
        }

        // --- 이벤트 리스너 설정 ---
        btcBtn.addEventListener('click', () => {
            if (currentCoin === 'BTC') return;
            currentCoin = 'BTC';
            btcBtn.classList.add('active');
            ethBtn.classList.remove('active');
            updateDashboard();
        });

        ethBtn.addEventListener('click', () => {
            if (currentCoin === 'ETH') return;
            currentCoin = 'ETH';
            ethBtn.classList.add('active');
            btcBtn.classList.remove('active');
            updateDashboard();
        });

        fullscreenBtn.addEventListener('click', () => {
            comparisonChartContainer.classList.toggle('fullscreen-mode');
            if (comparisonChartContainer.classList.contains('fullscreen-mode')) {
                fullscreenBtn.innerHTML = '↙';
                fullscreenBtn.title = '전체 화면 닫기';
            } else {
                fullscreenBtn.innerHTML = '↗';
                fullscreenBtn.title = '전체 화면';
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && comparisonChartContainer.classList.contains('fullscreen-mode')) {
                comparisonChartContainer.classList.remove('fullscreen-mode');
                fullscreenBtn.innerHTML = '↗';
                fullscreenBtn.title = '전체 화면';
            }
        });

        // --- 초기 실행 및 주기적 업데이트 ---
        document.addEventListener('DOMContentLoaded', () => {
            updateDashboard();
            displayCurrentTime();
            setInterval(displayCurrentTime, 1000);
            setInterval(() => fetchPrice(currentCoin), 30000);
        });
    </script>
</body>

</html>
