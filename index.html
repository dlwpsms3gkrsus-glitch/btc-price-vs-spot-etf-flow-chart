<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoFlow Tracker - BTC/ETH ETF 비교</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* 기본 스타일 */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            background-color: #121826;
            color: #E5ECF6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        a {
            color: #FFB800;
            text-decoration: none;
        }
        /* 헤더 스타일 */
        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px solid #2a3f5f;
            flex-wrap: wrap;
        }
        .logo-section {
            display: flex;
            flex-direction: column;
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        .timestamp {
            font-size: 12px;
            color: #8c9db3;
            margin-top: 5px;
        }
        /* BTC/ETH 전환 버튼 스타일 */
        .coin-switcher {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .coin-switcher button {
            background-color: #2a3f5f;
            color: #E5ECF6;
            border: 1px solid #2a3f5f;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .coin-switcher button:hover {
            background-color: #3e5681;
        }
        .coin-switcher button.active {
            background-color: #FFB800;
            color: #121826;
            border-color: #FFB800;
        }
        .coin-switcher button i {
            margin-right: 8px;
        }
        .header-metrics {
            display: flex;
            gap: 40px; /* 간격 조정 */
        }
        .live-crypto-price, .live-etf-inflow {
            text-align: right;
        }
        .live-crypto-price .price, .live-etf-inflow .total {
            font-size: 28px;
            font-weight: bold;
        }
        .live-crypto-price .change, .live-etf-inflow .change {
            font-size: 16px;
        }
        /* 공통 상승/하락 색상 */
        .up { color: #4CAF50 !important; }
        .down { color: #F44336 !important; }
        /* 메인 대시보드 스타일 */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .main-chart-container {
            background-color: #1A2233;
            padding: 20px;
            border-radius: 8px;
            height: 500px;
            position: relative;
        }
        h2 {
            margin-top: 0;
            font-weight: 500;
        }
        /* 상세 비교 차트 섹션 스타일 */
        .comparison-chart-section, .supply-details-section {
            background-color: #1A2233;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            position: relative;
        }
        .comparison-chart-section iframe {
            width: 100%;
            height: 500px;
            border: none;
            margin-top: 15px;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2a3f5f;
            padding-bottom: 10px;
        }
        .chart-header h2 {
            margin: 0;
            padding: 0;
            border-bottom: none;
        }
        .source-link-btn {
            background-color: #2a3f5f;
            color: #E5ECF6;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            text-decoration: none;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        .source-link-btn:hover {
            background-color: #3e5681;
        }
        .source-link-btn i {
            margin-left: 5px;
        }
        
        /* 전체 화면 버튼 스타일 */
        .fullscreen-btn {
            position: absolute;
            top: 18px;
            right: 20px;
            background-color: #2a3f5f;
            border: 1px solid #4a5f7f;
            color: #E5ECF6;
            cursor: pointer;
            border-radius: 5px;
            width: 32px;
            height: 32px;
            font-size: 18px;
            line-height: 30px;
            text-align: center;
        }
        
        /* 전체 화면 모드 스타일 */
        .comparison-chart-section.fullscreen-mode,
        .supply-details-section.fullscreen-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            border-radius: 0;
        }
        .fullscreen-mode iframe {
            height: calc(100% - 60px);
        }
        .fullscreen-mode .fullscreen-btn {
            top: 25px;
            right: 25px;
            z-index: 1001;
        }

        /* 공급량 상세 정보 섹션 스타일 */
        .supply-details-section.hidden {
            display: none;
        }
        
        .supply-header h2 {
            margin: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #2a3f5f;
            padding-right: 40px; 
        }

        .supply-info {
            display: flex;
            align-items: baseline;
            gap: 10px;
            margin-top: 15px;
            font-size: 20px;
            font-weight: bold;
        }
        .supply-percentage {
            font-size: 16px;
            color: #8c9db3;
            font-weight: normal;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #2a3f5f;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        .progress-bar {
            height: 10px;
            background-color: #FFB800;
            width: 0%; 
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }
        /* 푸터 스타일 */
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            border-top: 1px solid #2a3f5f;
            font-size: 14px;
            color: #8c9db3;
            line-height: 1.6;
        }
        .chart-source {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 12px;
            color: #8c9db3;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-section">
                <div class="logo">
                    <a href="#">CryptoFlow Tracker</a>
                </div>
                <div class="coin-switcher">
                    <button id="btn-btc" class="active"><i class="fa-brands fa-bitcoin"></i>BTC</button>
                    <button id="btn-eth"><i class="fa-brands fa-ethereum"></i>ETH</button>
                </div>
                <div class="timestamp" id="timestamp-display">Loading time...</div>
            </div>
            <div class="header-metrics">
                <div class="live-etf-inflow">
                    <div id="etf-title">Total ETF Net Inflow</div>
                    <div class="total" id="etf-inflow-total">Loading...</div>
                    <div class="change" id="etf-inflow-change"></div>
                </div>
                <div class="live-crypto-price">
                    <div id="price-title">Bitcoin Price</div>
                    <div class="price" id="crypto-price">Loading...</div>
                    <div class="change" id="crypto-change"></div>
                </div>
            </div>
        </header>

        <main>
            <div class="dashboard">
                <div class="main-chart-container">
                    <h2 id="chart-title" style="border-bottom: 1px solid #2a3f5f; padding-bottom: 10px;">실시간 비트코인 가격</h2>
                    <div id="chart-container" style="height: calc(100% - 45px); width:100%;"></div>
                    <div class="chart-source">Source: TradingView</div>
                </div>
            </div>
            
            <div id="comparison-chart-container" class="comparison-chart-section">
                <div class="chart-header">
                    <h2 id="comparison-chart-title">BTC 현물 ETF 현금 흐름 & 가격 비교</h2>
                    <a id="farside-link-btn" href="#" target="_blank" class="source-link-btn">
                        Farside 데이터 확인 <i class="fa-solid fa-arrow-up-right-from-square"></i>
                    </a>
                </div>
                <button id="fullscreen-btn" class="fullscreen-btn" title="전체 화면">↗</button>
                <iframe id="comparison-chart-iframe" src="graph_btc.html"></iframe>
            </div>

            <div id="btc-supply-section" class="supply-details-section">
                <div class="supply-header">
                    <h2>Bitcoin Supply Details</h2>
                </div>
                <div class="supply-info">
                    <div class="supply-text">
                        <span id="current-supply-btc">Loading...</span> / 21,000,000 BTC
                    </div>
                    <div class="supply-percentage" id="supply-percentage-btc">
                        (Loading...)
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="supply-progress-bar-btc"></div>
                </div>
            </div>

            <div id="eth-supply-section" class="supply-details-section hidden">
                <div class="supply-header">
                    <h2>Ethereum Supply Details</h2>
                </div>
                <button id="eth-fullscreen-btn" class="fullscreen-btn" title="전체 화면">↗</button>
                <div class="supply-info">
                     <span id="current-supply-eth">Loading...</span>
                </div>
                <iframe id="eth-supply-chart-iframe" src="graph_eth_supply.html" style="width: 100%; height: 550px; border: none; margin-top: 15px;"></iframe>
                
            </div>

        </main>
        
        <footer>
            <p>
                <a href="https://hits.seeyoufarm.com">
                    <img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fdlwpsms3gkrsus-glitch.github.io%2Fcrypto_price_vs_spot_etf_flow-chart%2F&count_bg=%2379C83D&title_bg=%23555555&icon=&icon_color=%23E7E7E7&title=visitors&edge_flat=false"/>
                </a>
            </p>
            <p>Website ver: 2.1 ver | Spot ETF Flow Source: <a href="https://farside.co.uk/" target="_blank">Farside Investors</a></p>
            <p>Created by: <a href="mailto:dlwpsms3gkrsus@gmail.com">dlwpsms3gkrsus@gmail.com</a></p>
        </footer>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        // --- DOM 요소 가져오기 ---
        const btcBtn = document.getElementById('btn-btc');
        const ethBtn = document.getElementById('btn-eth');
        const priceTitleElement = document.getElementById('price-title');
        const cryptoPriceElement = document.getElementById('crypto-price');
        const cryptoChangeElement = document.getElementById('crypto-change');
        const etfTitleElement = document.getElementById('etf-title');
        const etfTotalElement = document.getElementById('etf-inflow-total');
        const etfChangeElement = document.getElementById('etf-inflow-change');
        const chartTitleElement = document.getElementById('chart-title');
        const chartContainer = document.getElementById('chart-container');
        const timestampElement = document.getElementById('timestamp-display');
        const comparisonChartTitle = document.getElementById('comparison-chart-title');
        const comparisonChartIframe = document.getElementById('comparison-chart-iframe');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const comparisonChartContainer = document.getElementById('comparison-chart-container');
        const farsideLinkBtn = document.getElementById('farside-link-btn');
        // BTC 공급량 DOM
        const btcSupplySection = document.getElementById('btc-supply-section');
        const currentSupplyBtc = document.getElementById('current-supply-btc');
        const supplyPercentageBtc = document.getElementById('supply-percentage-btc');
        const supplyProgressBarBtc = document.getElementById('supply-progress-bar-btc');
        // ETH 공급량 DOM
        const ethSupplySection = document.getElementById('eth-supply-section');
        const currentSupplyEth = document.getElementById('current-supply-eth');
        const ethFullscreenBtn = document.getElementById('eth-fullscreen-btn');
        
        // --- 상태 관리 ---
        let currentCoin = 'BTC';
        let lastPrice = 0;

        // --- 데이터 업데이트 함수 ---
        async function fetchPrice(coin) {
            try {
                const response = await fetch(`https://min-api.cryptocompare.com/data/pricemultifull?fsyms=${coin}&tsyms=USD`);
                const data = await response.json();
                const priceData = data.RAW[coin].USD;
                
                priceTitleElement.innerText = `${coin === 'BTC' ? 'Bitcoin' : 'Ethereum'} Price`;
                cryptoPriceElement.innerText = `$${priceData.PRICE.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                
                const sign = priceData.CHANGE24HOUR >= 0 ? '+' : '';
                cryptoChangeElement.innerText = `${sign}${priceData.CHANGE24HOUR.toFixed(2)} (${sign}${priceData.CHANGEPCT24HOUR.toFixed(2)}%)`;
                
                cryptoPriceElement.classList.toggle('up', priceData.PRICE > lastPrice);
                cryptoPriceElement.classList.toggle('down', priceData.PRICE < lastPrice);
                cryptoChangeElement.classList.toggle('up', priceData.CHANGE24HOUR >= 0);
                cryptoChangeElement.classList.toggle('down', priceData.CHANGE24HOUR < 0);
                
                lastPrice = priceData.PRICE;
            } catch (error) { console.error(`Error fetching ${coin} price:`, error); }
        }

        async function displayEtfData(coin) {
            etfTitleElement.innerText = `Total ${coin} ETF Net Inflow`;
            const csvFileName = coin === 'BTC' ? 'bitcoin_etf_total_flow.csv' : 'ethereum_etf_total_flow.csv';
            try {
                const response = await fetch(csvFileName);
                if (!response.ok) throw new Error('Network response was not ok.');
                const csvText = await response.text();
                const rows = csvText.trim().split('\n');
                
                const lastRow = rows[rows.length - 1];
                const dailyInflow = parseFloat(lastRow.split(',')[1]);

                let cumulativeInflow = 0;
                for (let i = 1; i < rows.length; i++) {
                    const value = parseFloat(rows[i].split(',')[1]);
                    if (!isNaN(value)) cumulativeInflow += value;
                }
                
                const formatLargeNumber = (num) => {
                    if (Math.abs(num) >= 1.0e+9) return `$${(num / 1.0e+9).toFixed(2)}B`;
                    if (Math.abs(num) >= 1.0e+6) return `$${(num / 1.0e+6).toFixed(2)}M`;
                    return `$${num.toLocaleString()}`;
                };

                etfTotalElement.innerText = formatLargeNumber(cumulativeInflow * 1000000);
                const sign = dailyInflow >= 0 ? '+' : '';
                etfChangeElement.innerText = `${sign}${formatLargeNumber(dailyInflow * 1000000)} (Daily)`;
                
                etfTotalElement.classList.toggle('up', cumulativeInflow >= 0);
                etfTotalElement.classList.toggle('down', cumulativeInflow < 0);
                etfChangeElement.classList.toggle('up', dailyInflow >= 0);
                etfChangeElement.classList.toggle('down', dailyInflow < 0);
            } catch (error) {
                etfTotalElement.innerText = '데이터 로드 실패';
                etfChangeElement.innerText = '';
            }
        }
        
        function updateChart(coin) {
            chartTitleElement.innerText = `실시간 ${coin === 'BTC' ? '비트코인' : '이더리움'} 가격`;
            chartContainer.innerHTML = '';
            new TradingView.widget({
                "autosize": true, "symbol": `BITSTAMP:${coin}USD`, "interval": "D",
                "timezone": "Etc/UTC", "theme": "dark", "style": "1", "locale": "ko",
                "enable_publishing": false, "allow_symbol_change": false, "container_id": "chart-container"
            });
        }
        
        function displayCurrentTime() {
            const now = new Date();
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            const usEasternTime = now.toLocaleString('en-US', { ...options, timeZone: 'America/New_York' });
            const koreaTime = now.toLocaleString('ko-KR', { ...options, timeZone: 'Asia/Seoul' });
            timestampElement.innerHTML = `🇺🇸 ${usEasternTime} (US Eastern)<br>🇰🇷 ${koreaTime} (Korea)`;
        }

        function updateComparisonChart(coin) {
            const coinName = coin === 'BTC' ? 'BTC' : 'ETH';
            const chartFile = coin === 'BTC' ? 'graph_btc.html' : 'graph_eth.html';
            const farsideLink = coin === 'BTC' 
                ? 'https://farside.co.uk/bitcoin-etf-flow-all-data/' 
                : 'https://farside.co.uk/ethereum-etf-flow-all-data/';
            
            comparisonChartTitle.innerText = `${coinName} 현물 ETF 현금 흐름 & 가격 비교`;
            comparisonChartIframe.src = chartFile;
            farsideLinkBtn.href = farsideLink;
        }
        
        async function updateBtcSupplyDetails() {
            try {
                const response = await fetch(`https://blockchain.info/q/totalbc`);
                const satoshis = await response.text();
                const currentSupply = parseFloat(satoshis) / 100000000;
                const maxSupply = 21000000;
                const percentage = (currentSupply / maxSupply) * 100;

                currentSupplyBtc.innerText = `${currentSupply.toLocaleString('en-US', {maximumFractionDigits: 0})} BTC`;
                supplyPercentageBtc.innerText = `(${percentage.toFixed(4)}%)`;
                supplyProgressBarBtc.style.width = `${percentage}%`;
            } catch (error) {
                currentSupplyBtc.innerText = 'Error';
            }
        }
        
        async function updateEthSupplyDetails() {
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/coins/ethereum?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false`);
                const data = await response.json();
                const circulatingSupply = data.market_data.circulating_supply;
                currentSupplyEth.innerText = `현재 발행량: ${circulatingSupply.toLocaleString('en-US', {maximumFractionDigits: 0})} ETH`;
            } catch(error) {
                console.error('Error fetching ETH supply:', error);
                currentSupplyEth.innerText = '현재 발행량: 데이터 로드 실패';
            }
        }

        // --- 메인 컨트롤 함수 ---
        function updateDashboard() {
            lastPrice = 0;
            fetchPrice(currentCoin);
            displayEtfData(currentCoin);
            updateChart(currentCoin);
            updateComparisonChart(currentCoin);

            if (currentCoin === 'BTC') {
                updateBtcSupplyDetails();
                btcSupplySection.classList.remove('hidden');
                ethSupplySection.classList.add('hidden');
            } else { // ETH
                updateEthSupplyDetails();
                btcSupplySection.classList.add('hidden');
                ethSupplySection.classList.remove('hidden');
            }
        }

        // --- 이벤트 리스너 설정 ---
        btcBtn.addEventListener('click', () => {
            if (currentCoin === 'BTC') return;
            currentCoin = 'BTC';
            btcBtn.classList.add('active');
            ethBtn.classList.remove('active');
            updateDashboard();
        });

        ethBtn.addEventListener('click', () => {
            if (currentCoin === 'ETH') return;
            currentCoin = 'ETH';
            ethBtn.classList.add('active');
            btcBtn.classList.remove('active');
            updateDashboard();
        });

        fullscreenBtn.addEventListener('click', () => {
            comparisonChartContainer.classList.toggle('fullscreen-mode');
            const icon = comparisonChartContainer.classList.contains('fullscreen-mode');
            fullscreenBtn.innerHTML = icon ? '↙' : '↗';
            fullscreenBtn.title = icon ? '전체 화면 닫기' : '전체 화면';
        });

        ethFullscreenBtn.addEventListener('click', () => {
            ethSupplySection.classList.toggle('fullscreen-mode');
            const icon = ethSupplySection.classList.contains('fullscreen-mode');
            ethFullscreenBtn.innerHTML = icon ? '↙' : '↗';
            ethFullscreenBtn.title = icon ? '전체 화면 닫기' : '전체 화면';
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (comparisonChartContainer.classList.contains('fullscreen-mode')) {
                    fullscreenBtn.click();
                }
                if (ethSupplySection.classList.contains('fullscreen-mode')) {
                    ethFullscreenBtn.click();
                }
            }
        });

        // --- 초기 실행 및 주기적 업데이트 ---
        document.addEventListener('DOMContentLoaded', () => {
            updateDashboard();
            displayCurrentTime();
            setInterval(displayCurrentTime, 1000);
            setInterval(() => fetchPrice(currentCoin), 30000);
            setInterval(() => {
                if(currentCoin === 'BTC') updateBtcSupplyDetails();
                else updateEthSupplyDetails();
            }, 300000); // 5분마다 공급량 업데이트
        });
    </script>
</body>
</html>
